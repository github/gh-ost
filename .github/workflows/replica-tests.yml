name: migration tests
on:
  - pull_request

jobs:
  build:

    runs-on: ubuntu-20.04
    strategy:
      matrix:
        tests:
          - image: mysql:5.7
            engine: innodb
          - image: mysql:8.0
            engine: innodb
          - image: percona:5.7
            engine: innodb
          - image: percona:8.0
            engine: innodb
          - image: percona:5.7
            engine: rocksdb
          - image: percona:8.0
            engine: rocksdb

    steps:
    - uses: actions/checkout@v2

    - name: generate mysql environment file
      env:
        TEST_STORAGE_ENGINE: "${{ matrix.tests.engine }}"
      run: localtests/mysql-env.sh

    - name: run localtests
      env:
        TEST_DOCKER_IMAGE: "${{ matrix.tests.image }}"
      run: docker-compose -f localtests/docker-compose.yml up --abort-on-container-exit --no-log-prefix tests

